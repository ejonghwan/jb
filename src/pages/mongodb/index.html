<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0"> -->
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
   
    <title>Document</title>
</head>
<body>

    <div class="wrap">
        <header>
            <nav class="global_wrap sub">
                <ul class="line"></ul>
            </nav>
        </header>
        <main>
            <div class="global_wrap">
                

                <!-- MongoDB -->
                <section class="conts">
                    <h2>MongoDB</h2>

                    <div class="depth_2">
                        <strong>-</strong>
                   
                    <!-- item -->
                    <div class="item_wrap">
                        <dl class="item">
                            <dt><button><span>-</span>.-</button></dt>
                            <dd>
                                -
                        </dd>
                        </dl>
                        <div class="code_wrap">
                        <pre>
                            <code class="javascript">
asd
                            </code>
                        </pre>
                        </div>
                    </div>
                    <!-- //item -->
                </div>
              </section>
              <!-- //MongoDB -->
                       
                <!-- Mongoose -->
                <section class="conts">
                    <h2>Mongoose</h2>

                <div class="depth_2">
                        <strong>타입, 속성</strong>
                   <!-- item -->
                   <div class="item_wrap">
                    <dl class="item">
                        <dt><button><span>mongoose</span> 스키마 생성</button></dt>
                        <dd>
                            -
                    </dd>
                    </dl>
                    <div class="code_wrap">
                    <pre>
                        <code class="javascript">


// # Schema type
String, Number, id, Date, Buffer, Boolean, Mixed, Array


// # Schema attribute
`
required:꼭 입력해야 한다.
unique:다른 행과 중복되면 안 된다.
trim:공백을 제거합니다.(문자열 타입에 사용)
default:문서가 생성되면 기본값으로 저장됩니다.
lowercase:대문자를 소문자로 저장한다(문자열 타입)
match:정규식으로 저장하려는 값과 비교한다.
validate:함수로 개발자가 조건을 만듭니다.
set:값을 입력할 때 함수로 조건을 만듭니다.
get:값을 출력할 때 함수로 조건을 만듭니다.
ref:해당하는 모델을 참조할 때 사용한다.
`


// package.json type="module"                             

import mongoose from 'mongoose'

const UserSchema = new mongoose.Schema({
    username: {
        type: String,
        required: true,
        unique: true,
    },
    name: {
        first: { type: String, required: true,},
        last: { type: String, required: true, }
    },
    age: Number,
    email: String,
    array: [
        { name: { type: String } }
    ]
}, {
    timestamps: true, //생성한 시간을 만들어줌, 업데이트할 때마다 업데이트키를 생성해줌 
})

const User = mongoose.model('user', UserSchema) //첫번째 인자로 모델 생성 (db에는 users로 저장)
export default User



                        </code>
                    </pre>
                    </div>
                </div>
                <!-- //item -->
                    <!-- item -->
                    <div class="item_wrap">
                        <dl class="item">
                            <dt><button><span>mongoose</span> type</button></dt>
                            <dd>
                                String, Number, id, Date, Buffer, Boolean, Mixed, Array
                        </dd>
                        </dl>
                        <div class="code_wrap">
                        <pre>
                            <code class="javascript">
`
타입 종류: String, Number, id, Date, Buffer, Boolean, Mixed, Array
`



var exampleSchema = new mongoose.Schema({
    name:{
     type:String,
     required:true
    }
    age:Number
    number:Schema.Types.ObjectId
    created:{
     type:Date,
     default:Date.now
    }
    binary:Buffer,
    living:Boolean
    mixed:Schema.Types.Mixed
    array:[],
    arrayNumber:[Number],
    arrayString:[String]
 });


                            </code>
                        </pre>
                        </div>
                    </div>
                    <!-- //item -->
                    <!-- item -->
                    <div class="item_wrap">
                        <dl class="item">
                            <dt><button><span>mongoose</span> attribute</button></dt>
                            <dd>
                                required, unique, trim, default, lowercase, match, validate, set, get, ref
                        </dd>
                        </dl>
                        <div class="code_wrap">
                        <pre>
                            <code class="javascript">
`
required:꼭 입력해야 한다.
unique:다른 행과 중복되면 안 된다.
trim:공백을 제거합니다.(문자열 타입에 사용)
default:문서가 생성되면 기본값으로 저장됩니다.
lowercase:대문자를 소문자로 저장한다(문자열 타입)
match:정규식으로 저장하려는 값과 비교한다.
validate:함수로 개발자가 조건을 만듭니다.
set:값을 입력할 때 함수로 조건을 만듭니다.
get:값을 출력할 때 함수로 조건을 만듭니다.
ref:해당하는 모델을 참조할 때 사용한다.
`

...
var exampleSchema = mongoose.Schema({
   firstName:{
    type:String,
    required:true,
    trim:true,
    lowercase:true  
   },
   lastName:{
    type:String,
    trim:true,
    lowercase:true
   }
   age:{
    type:Number,
    required:true,
   }
   created:{
    type:Date,
    default:Date.now
   },
   number:{
    type:Number,
    match:/^\d{3}-\d{3,4}-\d{4}$/
   },
   password:{
    type:String,
    validate:[
      function(password){
       return password&&password.length>6;
      },'비밀번호를 입력하거나 길이가 6보다커야합니다.'
     ]
   },
   author:{
    type:Schema.Types.Id,
    ref:'User'
   }
});



                            </code>
                        </pre>
                        </div>
                    </div>
                    <!-- //item -->
                    <!-- item -->
                    <div class="item_wrap">
                        <dl class="item">
                            <dt><button><span>mongoose</span> method</button></dt>
                            <dd>
                                -
                        </dd>
                        </dl>
                        <div class="code_wrap">
                        <pre>
                            <code class="javascript">
`
스키마에 적용하는 메서드들 
두 가지 방법으로 해당하는 스키마에서 사용할 수 있는 메서드를 생성했다.
methods와 statics 두 가지 방식으로 스키마 메서드를 만들 수 있다


methods 방식은 다큐 먼스를 CRUD 하여 나타낸 객체를 연산할 때 사용하고 
statics은 CRUD 하는 메서드와 같이 모델 변수에서 전역으로 사용
`

exampleSchema.methods.hash(password){
    ...
}
exampleSchema.static.findName(name,callback){
    findOne({name:name},callback)
}

var Data = mongoose.model('data',exampleSchema);

Data.findName(name,function(err,names){
     return name;
  }
);
Data.find(function(err,users){
  users.hash(password);
 }
);

                            </code>
                        </pre>
                        </div>
                    </div>
                    <!-- //item -->
                </div>
                <!-- 검증 -->
                <div class="depth_2">
                    <strong>메서드</strong>

                    <!-- item -->
                    <div class="item_wrap">
                        <dl class="item">
                            <dt><button><span>mongoose</span>.connect()</button></dt>
                            <dd>
                                몽고디비 연결
                        </dd>
                        </dl>
                        <div class="code_wrap">
                        <pre>
                            <code class="javascript">
import mongoose from 'mongoose'

const dbInfo = `mongodb+srv://${process.env.DB_NAME}:${process.env.DB_PASSWORD}@mongostudy.5g49u.mongodb.net/${process.env.DB_TITLE}?retryWrites=true&w=majority`

await mongoose.connect(dbInfo).then(result => console.log('몽고디비 연결성공'))

                            </code>
                        </pre>
                        </div>
                    </div>
                    <!-- //item -->
                     <!-- item -->
                     <div class="item_wrap">
                        <dl class="item">
                            <dt><button><span>mongoose</span>.set()</button></dt>
                            <dd>
                                -
                        </dd>
                        </dl>
                        <div class="code_wrap">
                        <pre>
                            <code class="javascript">
import mongoose from 'mongoose'

mongoose.set('debug', true) 
//query


                            </code>
                        </pre>
                        </div>
                    </div>
                    <!-- //item -->
                    <!-- item -->
                    <div class="item_wrap">
                        <dl class="item">
                            <dt><button><span>mongoose</span>.isValidObjectId()</button></dt>
                            <dd>
                                _id 검증
                        </dd>
                        </dl>
                        <div class="code_wrap">
                        <pre>
                            <code class="javascript">
client params로 넘어온 아이디가 몽고디비 _id와 형식? 이 같은지 검사해줌...
.isValidObjectId(_id)


import mongoose from 'mongoose'

if(!mongoose.isValidObjectId(userId)) { //isValidObjectId는 objectId 형식인지 불린값으로 리턴해줌
    res.status(400).json({ err: 'invalid userId' })
}
const user = await User.findOne({ _id: userId }) 

                            </code>
                        </pre>
                        </div>
                    </div>
                    <!-- //item -->
                   
                </div>
                <!-- 검증 -->

                <!-- 생성 -->
                <div class="depth_2">
                    <strong>생성</strong>

                    <!-- item -->
                    <div class="item_wrap">
                        <dl class="item">
                            <dt><button><span>mongoose</span>.save()</button></dt>
                            <dd>
                                생성
                        </dd>
                        </dl>
                        <div class="code_wrap">
                        <pre>
                            <code class="javascript">

import { User } from '../model/User'

app.post('/user', async (res, req) => {
    try {
        // 여기 검증은 유저가 잘못입력한거라 400
        let { username, name } = req.body; 
        if(!username) return res.status(400).send({ err: 'username is required' })
        if(!name || !name.first || !name.last) return res.status(400).send({ err: 'name is required' })


        const user = new User(req.body) //백엔드(몽구스)에 먼저 유저 인스턴스생성
        await user.save() // 디비에 저장..promise 리턴
        // 위 방식이면 몽구스에서 생성해서 디비에 저장한게 됨 
        // findOneAndUpdate(userId, {}, { new: true }) 이런 방식은 동시에 실행한거라 디비에서 작업이 이뤄짐

        return res.status(200).json(user)
    } catch(err) {
        console.log(err)
        return res.status(500).json({ err: err.message }) //여긴 서버에러라 500
    }
})





## 중요
.findOneAndUpdate()  vs   .save()


1) 이 방식은 두번 호출하지만 백엔드에서 불러온 데이터를 한번 수정할 수 있다는 장점이 있음..
단점은 두번 요청한다는 것(크게 무리가 가지 않는다고 함)  
.findOne()  
.save()

// 조회와 업데이트 모두 한방에 ! 방법 1 
let bodyObj = {}
if(req.body.age) bodyObj.age = req.body.age
if(req.body.name) bodyObj.name = req.body.name
if( req.body.email) bodyObj.email = req.body.email

console.log(bodyObj, 'asdasd')
"name": { "first": "cc", "last": "ee" }

//console.log(req.body)
const user = await User.findByIdAndUpdate(userId, {
    username: req.body.username,
   $set: { bodyObj },

}, { new: true })
const user = await User.findByIdAndUpdate(userId, bodyObj, { new: true })


----------------------------


2) 이 방식은 한번 처리되고 디비에서 작업이 이뤄짐. 요청이 한번만 이뤄지지만 복잡한 수정, 검증은 힘듦
.findOneAndUpdate()
.findOneAndDelete()
등등

// 조회 한번 하고 가져온 다음 업데이트하는 방법 2... 
// 이 방법은 검증이나 수정이 복잡하거나 여러 인스턴스를 가져와서 복잡적으로 수정해야 될 경우 
const user = await User.findById(userId) //가져와서 
if(req.body.age) user.age = req.body.age; // 검증함 하고 !
if(req.body.name) user.name = req.body.name;
user.save()  //담는다! 여기서 save()는 실제로 update 메서드가 실행됨..


// 이런식으로 했을 땐 { new: true } 도 필요없음..백엔드에서 몽구스로 가져온 다음 수정해서 다시 보내기 때문.
// 몽구스가 바뀐 것만 알아서  찾아주기 때문에 검증 후 새 객체에 넣어줄 필요도 없음 
res.status(200).json(user)

 

                            </code>
                        </pre>
                        </div>
                    </div>
                    <!-- //item -->
                </div>
                <!-- 생성 -->

                <!-- 검색 -->
                <div class="depth_2">
                    <strong>검색</strong>

                     <!-- item -->
                     <div class="item_wrap">
                        <dl class="item">
                            <dt><button><span>model</span>.find()</button></dt>
                            <dd>
                                다수 검색 (배열반환) 
                        </dd>
                        </dl>
                        <div class="code_wrap">
                        <pre>
                            <code class="javascript">
-

                            </code>
                        </pre>
                        </div>
                    </div>
                    <!-- //item -->
                     <!-- item -->
                     <div class="item_wrap">
                        <dl class="item">
                            <dt><button><span>model</span>.findOne()</button></dt>
                            <dd>
                                하나 검색 (객체반환)
                        </dd>
                        </dl>
                        <div class="code_wrap">
                        <pre>
                            <code class="javascript">
// 특정 값으로 찾기 
findOne({ name: " aaa " }) - 이렇게 하면 name: " aaa " 해당하는 것 한개만 불러옴


// 특정 유저아이디로 찾기 
app.get('/user/:userId', async (req, res) => {
    try {
        ...
        if(!mongoose.isValidObjectId(userId)) { //isValidObjectId는 objectId 형식인지 불린값으로 리턴해줌
            res.status(400).json({ err: 'invalid userId' })
        }

        const { userId } = req.params
        const findUser = await User.findOne({ _id: userId })
        res.status(200).json(findUser)

    } catch(err) {
        ...
    }
})

                            </code>
                        </pre>
                        </div>
                    </div>
                    <!-- //item -->
                     <!-- item -->
                     <div class="item_wrap">
                        <dl class="item">
                            <dt><button><span>model</span>.findByid()</button></dt>
                            <dd>
                                아이디로 검색
                        </dd>
                        </dl>
                        <div class="code_wrap">
                        <pre>
                            <code class="javascript">

const user = await User.findById(req.params.userId)

                            </code>
                        </pre>
                        </div>
                    </div>
                    <!-- //item -->
                     <!-- item -->
                     <div class="item_wrap">
                        <dl class="item">
                            <dt><button><span>model</span>.findOne()</button></dt>
                            <dd>
                                -
                        </dd>
                        </dl>
                        <div class="code_wrap">
                        <pre>
                            <code class="javascript">
-

                            </code>
                        </pre>
                        </div>
                    </div>
                    <!-- //item -->
                     <!-- item -->
                     <div class="item_wrap">
                        <dl class="item">
                            <dt><button><span>model</span>.findOne()</button></dt>
                            <dd>
                                -
                        </dd>
                        </dl>
                        <div class="code_wrap">
                        <pre>
                            <code class="javascript">
-

                            </code>
                        </pre>
                        </div>
                    </div>
                    <!-- //item -->
                     <!-- item -->
                     <div class="item_wrap">
                        <dl class="item">
                            <dt><button><span>model</span>.findOne()</button></dt>
                            <dd>
                                -
                        </dd>
                        </dl>
                        <div class="code_wrap">
                        <pre>
                            <code class="javascript">
-

                            </code>
                        </pre>
                        </div>
                    </div>
                    <!-- //item -->
                     <!-- item -->
                     <div class="item_wrap">
                        <dl class="item">
                            <dt><button><span>model</span>.findOne()</button></dt>
                            <dd>
                                -
                        </dd>
                        </dl>
                        <div class="code_wrap">
                        <pre>
                            <code class="javascript">
-

                            </code>
                        </pre>
                        </div>
                    </div>
                    <!-- //item -->
                     <!-- item -->
                     <div class="item_wrap">
                        <dl class="item">
                            <dt><button><span>model</span>.findOne()</button></dt>
                            <dd>
                                -
                        </dd>
                        </dl>
                        <div class="code_wrap">
                        <pre>
                            <code class="javascript">
-

                            </code>
                        </pre>
                        </div>
                    </div>
                    <!-- //item -->
                     <!-- item -->
                     <div class="item_wrap">
                        <dl class="item">
                            <dt><button><span>model</span>.findOne()</button></dt>
                            <dd>
                                -
                        </dd>
                        </dl>
                        <div class="code_wrap">
                        <pre>
                            <code class="javascript">
-

                            </code>
                        </pre>
                        </div>
                    </div>
                    <!-- //item -->
                     <!-- item -->
                     <div class="item_wrap">
                        <dl class="item">
                            <dt><button><span>model</span>.findOne()</button></dt>
                            <dd>
                                -
                        </dd>
                        </dl>
                        <div class="code_wrap">
                        <pre>
                            <code class="javascript">
-

                            </code>
                        </pre>
                        </div>
                    </div>
                    <!-- //item -->
                     <!-- item -->
                     <div class="item_wrap">
                        <dl class="item">
                            <dt><button><span>model</span>.findOne()</button></dt>
                            <dd>
                                -
                        </dd>
                        </dl>
                        <div class="code_wrap">
                        <pre>
                            <code class="javascript">
-

                            </code>
                        </pre>
                        </div>
                    </div>
                    <!-- //item -->
                     <!-- item -->
                     <div class="item_wrap">
                        <dl class="item">
                            <dt><button><span>model</span>.findOne()</button></dt>
                            <dd>
                                -
                        </dd>
                        </dl>
                        <div class="code_wrap">
                        <pre>
                            <code class="javascript">
-

                            </code>
                        </pre>
                        </div>
                    </div>
                    <!-- //item -->
                </div>
                <!-- 검색 -->


                 <!-- 수정 -->
                 <div class="depth_2">
                    <strong>수정</strong>

                      <!-- item -->
                      <div class="item_wrap">
                        <dl class="item">
                            <dt><button><span>model</span>.findOneAndUpdate()</button></dt>
                            <dd>
                                검색 후 수정 (반환)
                        </dd>
                        </dl>
                        <div class="code_wrap">
                        <pre>
                            <code class="javascript">

업데이트된 콜렉션 반환받고 싶으면 이거~

app.put('/user/update/:userId', async (req, res) => {
    try {

        ...
        const { age } req.body // 넘어온 age data
        const user = await User.findOneAndUpdate(req.params.userid, 
            { $set: { age: age } }, 
            { new: true }
        )
        // 해당 아이디의 값중에 age를 바꿈
        // new: true는 업데이트하고 난 다음 문서를 리턴해줌 ...안하면 안바뀐거 리턴

    } catch(err) {
        ....
    }
})




ex)
// @ path  /api/user/
router.put('/update/:userId', async(req, res) => {
    try {
        const { userId } = req.params 

        if(!mongoose.isValidObjectId(userId)) {
           res.status(400).json({ err: 'invalid userId' }) 
        }
        if(!req.body.age && !req.body.name) {
            res.status(400).json({ err: 'age or name is required' }) 
        }
        if(req.body.age && typeof req.body.age !== 'number') {
            res.status(400).json({ err: 'age must be a number' }) 
        }
        if(req.body.name && typeof req.body.name.first !== 'string' && typeof req.body.name.last !== 'string') {
            return res.status(400).json({ err: 'name must be a string' }) 
        }

        // 조회와 업데이트 모두 한방에 ! 방법 1 
        // let bodyObj = {}
        // if(req.body.age) bodyObj.age = req.body.age
        // if(req.body.name) bodyObj.name = req.body.name
        // if( req.body.email) bodyObj.email = req.body.email

        // console.log(bodyObj, 'asdasd')
        // "name": { "first": "cc", "last": "ee" }

        // console.log(req.body)
        // const user = await User.findByIdAndUpdate(userId, {
        //     // username: req.body.username,
        // //    $set: { bodyObj },
        
        // }, { new: true })
        // const user = await User.findByIdAndUpdate(userId, bodyObj, { new: true })


        // 조회 한번 하고 가져온 다음 업데이트하는 방법 2... 
        // 이 방법은 검증이나 수정이 복잡하거나 여러 인스턴스를 가져와서 복잡적으로 수정해야 될 경우 
        const user = await User.findById(userId) //가져와서 
        if(req.body.age) user.age = req.body.age; // 검증함 하고 !
        if(req.body.name) user.name = req.body.name;
        user.save()  //담는다! 여기서 save()는 실제로 update 메서드가 실행됨..


        // 이런식으로 했을 땐 { new: true } 도 필요없음..백엔드에서 몽구스로 가져온 다음 수정해서 다시 보내기 때문.
        // 몽구스가 바뀐 것만 알아서  찾아주기 때문에 검증 후 새 객체에 넣어줄 필요도 없음 
        res.status(200).json(user)



    } catch(err) {
        console.log(err)
    }
})

                            </code>
                        </pre>
                        </div>
                    </div>
                    <!-- //item -->
                </div>
                <!-- 수정 -->

                 <!-- 삭제 -->
                 <div class="depth_2">
                    <strong>삭제</strong>

                      <!-- item -->
                      <div class="item_wrap">
                        <dl class="item">
                            <dt><button><span>model</span>.deleteOne()</button></dt>
                            <dd>
                                하나 삭제
                        </dd>
                        </dl>
                        <div class="code_wrap">
                        <pre>
                            <code class="javascript">
얘는 삭제만 함.. 
콜렉션을 받을 필요없으면 얘가 좀 더 효율적  

const user = await User.deleteOne({ _id: params userId })

                            </code>
                        </pre>
                        </div>
                    </div>
                    <!-- //item -->
                      <!-- item -->
                      <div class="item_wrap">
                        <dl class="item">
                            <dt><button><span>model</span>.findOneAndDelete()</button></dt>
                            <dd>
                                검색 후 하나 삭제 (유저반환)
                        </dd>
                        </dl>
                        <div class="code_wrap">
                        <pre>
                            <code class="javascript">
검색 후 삭제.. 
콜렉션 받을거면 이거 써야됨
이유는 검색했는데 없으면 null이라서~


const user = await User.findOneAndDelete({ _id: params userId })

                            </code>
                        </pre>
                        </div>
                    </div>
                    <!-- //item -->
                    <!-- item -->
                    <div class="item_wrap">
                        <dl class="item">
                            <dt><button><span>model</span>.findOneAndRemove()</button></dt>
                            <dd>
                                -
                        </dd>
                        </dl>
                        <div class="code_wrap">
                        <pre>
                            <code class="javascript">
-

                            </code>
                        </pre>
                        </div>
                    </div>
                    <!-- //item -->
                    <!-- item -->
                    <div class="item_wrap">
                        <dl class="item">
                            <dt><button><span>model</span>.findOneAndRemove()</button></dt>
                            <dd>
                                -
                        </dd>
                        </dl>
                        <div class="code_wrap">
                        <pre>
                            <code class="javascript">
-

                            </code>
                        </pre>
                        </div>
                    </div>
                    <!-- //item -->
                    <!-- item -->
                    <div class="item_wrap">
                        <dl class="item">
                            <dt><button><span>model</span>.findOneAndRemove()</button></dt>
                            <dd>
                                -
                        </dd>
                        </dl>
                        <div class="code_wrap">
                        <pre>
                            <code class="javascript">
-

                            </code>
                        </pre>
                        </div>
                    </div>
                    <!-- //item -->
                </div>
                <!-- 삭제 -->




              </section>
              <!-- //Mongoose -->


            </div>
        </main>
        <footer>
            <div class="global_wrap">
                <ul class="info">
                    asdasdsa
                </ul>
            </div>
        </footer>
    </div>


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/vs2015.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
</body>
</html>